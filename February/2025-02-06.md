## ğŸ“… ë‚ ì§œ: 2025-02-06


### ğŸ’¬ í•™ìŠµ ëª©í‘œ

- í•™ìŠµ ëª©í‘œ 1 : express server ì— nginx ì„¤ì¹˜í•˜ê³  Blue/Green ë°°í¬ ì„¤ì •


### ğŸ“’ 6ì£¼ì°¨ ê³¼ì œ 1ë²ˆ ë§ˆë¬´ë¦¬
#### | 1. express server ì— nginx ì„¤ì¹˜í•˜ê³  Blue/Green ë°°í¬ ì„¤ì •

`ìˆœì„œ ìœ„ì£¼ë¡œ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤. ë‚´ìš©ì€ ë…¸ì…˜ ê³¼ì œí˜ì´ì§€ì— ìì„¸í•˜ê²Œ ì—…ë¡œë“œ ì˜ˆì •ì…ë‹ˆë‹¤.`

0. ì‚¬ì „ ê³µë¶€
    - ì„œë²„ êµ¬ì¡° ì´í•´í•˜ê¸°
    - íŒŒì¼ êµ¬ì¡° ìƒê°í•˜ê¸°
        ```
        /home/ubuntu/deploy
        â”œâ”€â”€ docker-compose.yml
        â”œâ”€â”€ Dockerfile.frontend
        â”œâ”€â”€ Dockerfile.backend
        â”œâ”€â”€ 2-siena-eom-community-fe-1/ # í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ
        â”‚   â”œâ”€â”€ index.js
        â”‚   â”œâ”€â”€ html/
        â”‚   â”œâ”€â”€ css/
        â”‚   â””â”€â”€ js/
        â””â”€â”€ 2-siena-eom-community-be/   # ë°±ì—”ë“œ ì½”ë“œ    
                â”œâ”€â”€ package.json
            â”œâ”€â”€ server.js
            â””â”€â”€ routes/
        ```
    - ë°±ì—”ë“œ ë° í”„ë¡ íŠ¸ì—”ë“œì— í•„ìš”í•œ íŒŒì¼(ex env, config.js ë“±) ìƒì„±
    - ì½”ë“œ ìˆ˜ì • (nginx ì‚¬ìš©í•  ì˜ˆì •ì´ë¯€ë¡œ cors ì„¤ì •ì—ì„œ í¬íŠ¸ ë¹¼ê¸°)

1. nginx ì„¤ì¹˜
2. Docker ì„¤ì¹˜
3. Docker-compose ì„¤ì¹˜

4. Blue/Green ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤ ê³ ë¯¼í•˜ê¸°
    - **ìµœì´ˆ ë°°í¬**

        0ï¸âƒ£Â ë¸”ë£¨ ì„œë²„(8080, 3001) ì‹¤í–‰
    
        1ï¸âƒ£Â Nginxë¥¼ Blue ì„œë²„ì™€ ì—°ê²° â‡’ íŠ¸ë˜í”½ ë¼ìš°íŒ… ì„¤ì •
    
        3ï¸âƒ£Â ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™ í™•ì¸ â‡’ `curl` ì²´í¬, ë¸Œë¼ìš°ì € í™•ì¸

    - **ë¸”ë£¨ê·¸ë¦°ë°°í¬** (ì„œë²„ ì—…ë°ì´íŠ¸)

        1ï¸âƒ£ ë¸”ë£¨ ì„œë²„(8080,3001)ì™€ ê·¸ë¦° ì„œë²„(8081,3002) íŒë³„
        
        `docker ps` ëª…ë ¹ì–´ë¡œ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•˜ì—¬ í˜„ì¬ í™œì„±í™”ëœ ì„œë²„ë¥¼ íŒë³„ 
        
        2ï¸âƒ£Â ê·¸ë¦° ì„œë²„ì— ìƒˆë¡œìš´ ë²„ì „ì„ ë°°í¬
        
        í˜„ì¬ ì—°ê²°ë˜ì§€ ì•Šì€ Green ì„œë²„(8001, 3002)ì— ìƒˆë¡œìš´ ë²„ì „ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰
        
        3ï¸âƒ£Â ê·¸ë¦° ì„œë²„ í—¬ìŠ¤ ì²´í¬
        
        ìƒˆë¡œìš´ Green ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ curlì„ ì´ìš©í•˜ì—¬ í—¬ìŠ¤ì²´í¬
        
        4ï¸âƒ£Â Nginx ì„¤ì •ì„ í†µí•´ ë¸”ë£¨ì„œë²„ì™€ ì—°ê²°ì„ ëŠê³  ê·¸ë¦° ì„œë²„ì™€ ì—°ê²°
        
        `/etc/nginx/sites-enabled/default`Â ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ë³€ê²½í•˜ì—¬Â **Nginxë¥¼ Green ì„œë²„(8081, 3002)ë¡œ ì „í™˜**.
    
        5ï¸âƒ£Â ë¸”ë£¨ ì„œë²„ ì¢…ë£Œ
    
        ìƒˆë¡œìš´ Green ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì´ í™•ì¸ë˜ë©´, ê¸°ì¡´ Blue ì„œë²„(8080, 3001)ë¥¼ ì¢…ë£Œ.

- ìµœì´ˆ ë°°í¬ (ë¸”ë£¨ ì»¨í…Œì´ë„ˆ)

5. `Dockerfile` íŒŒì¼ ì‘ì„± ë° ì´ë¯¸ì§€ ë¹Œë“œ

    `docker images` ë¡œ í™•ì¸

6. `docker-compose.yml` íŒŒì¼ ì‘ì„±

    
    ```yaml
    version: '3'

    services:
    frontend-blue:
        image: siena-frontend:1.0
        container_name: frontend-blue
        ports:
        - "8080:8080"

    frontend-green:
        image: siena-frontend:1.1
        container_name: frontend-green
        ports:
        - "8081:8081"

    backend-blue:
        image: siena-backend:1.0
        container_name: backend-blue
        ports:
        - "3001:3001"
        env_file:
        - ./2-siena-eom-community-be/.env.prod

    backend-green:
        image: siena-backend:1.1
        container_name: backend-green
        ports:
        - "3002:3002"
        env_file:
        - ./2-siena-eom-community-be/.env.prod
    ```

7. Nginx ì„¤ì •

    <img width="673" alt="Image" src="https://github.com/user-attachments/assets/7f5e88cd-83b8-4feb-9397-b6dfa024c132" />
    
    íŠ¸ë˜í”½ì„ Blue ë˜ëŠ” Green ìœ¼ë¡œ ë³´ë‚¼ Nginx ì„¤ì • íŒŒì¼ ì‘ì„±

    Blue í™˜ê²½ (`/etc/nginx/sites-available/blue`)
    ```bash
    server {
        listen 80;

        # ëª¨ë“  HTTP ìš”ì²­ì„ Express ì„œë²„(8080)ë¡œ ì „ë‹¬
        location / {
            proxy_pass http://127.0.0.1:8080;  # Express ì„œë²„ë¡œ ìš”ì²­ ì „ë‹¬
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /users/ {
            proxy_pass http://127.0.0.1:3001;
        }

        location /posts/ {
            proxy_pass http://127.0.0.1:3001;
        }

        location /guest/ {
            proxy_pass http://127.0.0.1:3001;
        }
    }
    ```

    Greenì€ í¬íŠ¸ ë²ˆí˜¸ ìˆ˜ì •í•´ì£¼ê¸°
    
    ```
    RESTful API ì‘ì„±í•  ë•Œ /apië¥¼ ì™œ ë¶™ì´ëŠ”ê±°ì§€? ë¼ê³  ìƒê°í–ˆì—ˆë‹¤.
    nginx íŒŒì¼ ì‘ì„±í•˜ë‹¤ë³´ë‹ˆ ì´ì œì•¼ ì•Œê² ë”ë¼.. ì§€ê¸ˆì€ ê²¨ìš° ì„¸ ê°ˆë˜ë¼ ì €ë ‡ê²Œ ì ì—ˆì§€ë§Œ ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ì˜€ìœ¼ë©´ í°ì¼ë‚  ë»”^^..
    ë³´í†µ ê´€ë¡€ìƒ ë°±ì—”ë“œ apiëŠ” /apië¡œ ì‹œì‘í•œë‹¤.... << ê¸°ì–µí•˜ê¸°ğŸ¥²
    ```

8. ìµœì´ˆ ë°°í¬ (Blue í™˜ê²½)

    ```bash
    docker-compose up -d frontend-blue backend-blue
    ```

    `docker ps` ë¡œ í™•ì¸

    - ìµœì´ˆ ë°°í¬ ì´í›„ Nginxê°€ Blue ì„œë²„ì™€ ì—°ê²°ë˜ë„ë¡ ì„¤ì •
        
        ```bash
        sudo ln -sf /etc/nginx/sites-available/blue /etc/nginx/sites-enabled/default
        ```
        
    - ì„¤ì • í…ŒìŠ¤íŠ¸
        
        ```bash
        sudo nginx -t
        ```
        
    - Nginx ì¬ì‹œì‘
        
        ```bash
        sudo systemctl restart nginx
        ```

    ë¸Œë¼ìš°ì €ë¡œ ìµœì´ˆ ë°°í¬ í™•ì¸!

- Blue/Green ë°°í¬

1. AWS ë³´ì•ˆê·¸ë£¹ì—ì„œ Greenì—ì„œ ì“¸ í¬íŠ¸ í—ˆìš©í•´ì£¼ê¸°
2. ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¹Œë“œ
    
    ì½”ë“œ ìˆ˜ì •ì‚¬í•­(í¬íŠ¸, í™˜ê²½ë³€ìˆ˜, config.js) ë°˜ì˜í•´ì„œ ì´ë¯¸ì§€ ë§Œë“¤ê¸°
    ì´ë•Œ `docker-compose.yml` ì— ì •ì˜í•´ë†“ì€ ì´ë¦„ìœ¼ë¡œ ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •í•˜ê¸°
    `siena-frontend:1.1`, `siena-backend:1.1`

3. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±í•˜ê¸°

    `deploy.sh`

    ```bash
    #!/bin/bash

    # 1ï¸âƒ£ í˜„ì¬ í™œì„±í™”ëœ í™˜ê²½ í™•ì¸
    echo "ğŸ” í˜„ì¬ í™œì„±í™”ëœ í™˜ê²½ í™•ì¸..."
    CURRENT_ENV=$(docker ps --format "{{.Names}}" | grep frontend-blue)

    if [ -n "$CURRENT_ENV" ]; then
        echo "ğŸ”µ í˜„ì¬ Blue(8080, 3001)ê°€ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤. Green(8081, 3002)ë¡œ ë°°í¬ ì‹œì‘!"
        TARGET_ENV="green"
        TARGET_FRONTEND_PORT=8081
        TARGET_BACKEND_PORT=3002
        SOURCE_ENV="blue"
    else
        echo "ğŸŸ¢ í˜„ì¬ Green(8081, 3002)ê°€ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤. Blue(8080, 3001)ë¡œ ë°°í¬ ì‹œì‘!"
        TARGET_ENV="blue"
        TARGET_FRONTEND_PORT=8080
        TARGET_BACKEND_PORT=3001
        SOURCE_ENV="green"
    fi

    # 2ï¸âƒ£ ìƒˆë¡œìš´ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    echo "ğŸš€ ìƒˆë¡œìš´ $TARGET_ENV í™˜ê²½ì˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
    docker-compose up -d frontend-$TARGET_ENV backend-$TARGET_ENV

    # 3ï¸âƒ£ í—¬ìŠ¤ ì²´í¬
    echo "ğŸ” $TARGET_ENV ì„œë²„ í—¬ìŠ¤ ì²´í¬..."
    for i in {1..10}; do
        if curl -s "http://127.0.0.1:$TARGET_FRONTEND_PORT" > /dev/null; then
            echo "âœ… $TARGET_ENV ì„œë²„ ì •ìƒ ì‘ë™ í™•ì¸!"
            break
        fi
        echo "â³ í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ ($i/10)..."
        if [ $i -eq 10 ]; then
            echo "âŒ $TARGET_ENV ì„œë²„ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ ì¤‘ë‹¨."
            exit 1
        fi
        sleep 3
    done

    # 4ï¸âƒ£ Nginx ì„¤ì • ë³€ê²½
    echo "âš™ï¸ Nginxë¥¼ $TARGET_ENV í™˜ê²½ìœ¼ë¡œ ì „í™˜..."
    sudo ln -sf /etc/nginx/sites-available/$TARGET_ENV /etc/nginx/sites-enabled/default

    # Green ì„¤ì • í™•ì¸
    echo "ğŸ” í™œì„±í™”ëœ Nginx ì„¤ì • íŒŒì¼ í™•ì¸:"
    ls -l /etc/nginx/sites-enabled/

    echo "ğŸ”„ Nginx ì„¤ì • ì ìš© ì¤‘..."
    sudo systemctl restart nginx
    sudo nginx -s reload

    # 5ï¸âƒ£ ê¸°ì¡´ í™˜ê²½ ì¢…ë£Œ
    echo "ğŸ›‘ ê¸°ì¡´ $SOURCE_ENV í™˜ê²½ì˜ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì¤‘..."
    docker stop frontend-$SOURCE_ENV backend-$SOURCE_ENV
    docker rm frontend-$SOURCE_ENV backend-$SOURCE_ENV

    echo "âœ… ë°°í¬ ì™„ë£Œ! í˜„ì¬ $TARGET_ENV(í”„ë¡ íŠ¸ì—”ë“œ: $TARGET_FRONTEND_PORT, ë°±ì—”ë“œ: $TARGET_BACKEND_PORT)ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
    ```

    - ìŠ¤í¬ë¦½íŠ¸ì‹¤í–‰
    
    ```bash
    chmod +x deploy.sh
    ./deploy.sh
    ```

    <img width="1200" alt="Image" src="https://github.com/user-attachments/assets/cb53de28-1c3e-43f2-bf0a-59101cbdcbed" />


### ğŸ§‘â€ğŸ§’â€ğŸ§’ íŒ€ ìŠ¤í„°ë”” - ì½”ë”©í…ŒìŠ¤íŠ¸
#### | ë§¤ì¼ í•œ ë¬¸ì œ ì´ìƒ í’€ê¸°!

1. (ì˜¤ëŠ˜) ë‚´ê°€ í‘¼ ë¬¸ì œ

- 10ì£¼ì°¨
    - ë°±ì¤€ 2445, 2446

2. ìŠ¤í„°ë”” ì‹œê°„ì— í‘¼ ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°

    - í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ Lv1. ëŒ€ì¶© ë§Œë“  ìíŒ

### ğŸ”¥ ë„ì „ ê³¼ì œ ë‹¬ì„± í™•ì¸, ë‚´ì¼ì˜ ë„ì „ê³¼ì œ ì„¤ì •
- (ì§€ë‚œ) ë„ì „ ê³¼ì œ 1: 6ì£¼ì°¨ê³¼ì œ 2ë²ˆ ì‹œì‘í•˜ê¸° âŒ

- (ë‚´ì¼) ë„ì „ ê³¼ì œ 1: 6ì£¼ì°¨ ê³¼ì œ 1ë²ˆ ì •ë¦¬í•˜ê¸°

<br/>

### ğŸ’­ ì˜¤ëŠ˜ì˜ íšŒê³  (ì´ ê³µë¶€ì‹œê°„ 7:53:00)
- ì„±ê³µì ì¸ ì : ë“œë””ì–´ 6ì£¼ì°¨ ê³¼ì œ 1ë²ˆ ì™„ë£Œã… ã…  ì¸ìƒ ì²« ë°°í¬ ì™„ë£Œ ëˆˆë¬¼ ì¢”ì¢”ã… ã…  <br/>
- ê°œì„ í•´ì•¼í•  ì : TILì— ì •ë¦¬í•˜ì§€ì•Šì€ ë¬´ìˆ˜í•œ ì˜¤ë¥˜ì™€ ì‚½ì§ˆ, ë©ì²­ì´ìŠˆê°€ ê°€ë“í–ˆë‹¤. ,.. . ... <br/>

<br/>

### ğŸ“ ì°¸ê³  ìë£Œ ë° ë§í¬
- [Nginx HTTP Upstream ì•Œì•„ë³´ê¸°](https://westlife0615.tistory.com/265)

- [Nginx ì„¤ì¹˜ ë° nginx.conf, default.conf ì´í•´í•˜ê¸°](https://phsun102.tistory.com/45)

- [[nginx] nginxì—ì„œ reverse proxy ì‚¬ìš©í•˜ê¸°(feat. ìš°ì„  ìˆœìœ„)](https://icerabbit.tistory.com/116)